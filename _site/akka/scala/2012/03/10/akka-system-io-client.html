<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Akka system IO client</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Akka system IO client</h2>
<p class="meta">10 Mar 2012</p>

<div class="post">
<strong>
</strong>Network clients can also be implemented using Akka System IO.

The following provides a simple client that contents to the LengthCountedServer, Â simplistically modified to echo back the received text to all attached clients

Note that all the operations are asynchronous, including the connection creation on line 24. The API returns a SocketHandle, even if the connection cannot be made. The clarity of system state we wait for the Connected operation before registering a handle.

<div class="highlight"><pre><code class="scala"><span class="k">case</span> <span class="nc">Read</span><span class="o">(</span><span class="n">socket</span><span class="o">,</span> <span class="n">bytes</span><span class="o">)</span> <span class="k">=&gt;</span>
 <span class="n">state</span><span class="o">(</span><span class="n">socket</span><span class="o">)(</span><span class="nc">Chunk</span><span class="o">(</span><span class="n">bytes</span><span class="o">))</span>
 <span class="n">state</span><span class="o">.</span><span class="n">foreach</span><span class="o">{</span><span class="n">p</span> <span class="k">=&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">_1</span><span class="o">.</span><span class="n">asWritable</span><span class="o">.</span><span class="n">write</span><span class="o">(</span><span class="n">bytes</span><span class="o">)}</span>
</code></pre></div>
<div class="highlight"><pre><code class="scala"><span class="k">import</span> <span class="nn">akka.actor._</span>
<span class="k">import</span> <span class="nn">akka.util.</span><span class="o">{</span> <span class="nc">ByteString</span><span class="o">,</span> <span class="nc">ByteStringBuilder</span> <span class="o">}</span>
<span class="k">import</span> <span class="nn">java.net.InetSocketAddress</span>

<span class="k">class</span> <span class="nc">LengthBoundedClient</span><span class="o">(</span><span class="n">port</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">IO._</span>

  <span class="k">var</span> <span class="n">handle</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">SocketHandle</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span>
  <span class="k">var</span> <span class="n">respondTo</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">ActorRef</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span>

  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Read</span><span class="o">(</span><span class="n">socket</span><span class="o">,</span> <span class="n">bytes</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">respondTo</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> <span class="k">_</span> <span class="o">!</span> <span class="n">bytes</span> <span class="o">}</span>

    <span class="k">case</span> <span class="nc">Closed</span><span class="o">(</span><span class="n">socket</span><span class="o">,</span> <span class="n">cause</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">handle</span> <span class="k">=</span> <span class="nc">None</span>

    <span class="k">case</span> <span class="nc">Connected</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">handle</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">h</span><span class="o">)</span>

    <span class="k">case</span> <span class="n">s</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="n">handle</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> <span class="k">_</span> <span class="n">write</span> <span class="nc">ByteString</span><span class="o">(</span><span class="s">&quot;%04d%s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">length</span><span class="o">,</span> <span class="n">s</span><span class="o">))</span> <span class="o">}</span>

    <span class="k">case</span> <span class="nc">Attach</span><span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">respondTo</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
      <span class="nc">IOManager</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="n">system</span><span class="o">).</span><span class="n">connect</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="n">port</span><span class="o">))</span>

    <span class="k">case</span> <span class="nc">Detach</span> <span class="k">=&gt;</span> <span class="n">handle</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">close</span> <span class="o">};</span> <span class="n">handle</span> <span class="k">=</span> <span class="nc">None</span>
  <span class="o">}</span>

<span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Attach</span><span class="o">(</span><span class="n">respondTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Detach</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">RespondTo</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">bytes</span><span class="k">:</span> <span class="kt">ByteString</span> <span class="o">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="n">decodeString</span><span class="o">(</span><span class="s">&quot;US-ASCII&quot;</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Client</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">port</span> <span class="k">=</span> <span class="nc">Option</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">getenv</span><span class="o">(</span><span class="s">&quot;PORT&quot;</span><span class="o">))</span> <span class="n">map</span> <span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span> <span class="n">getOrElse</span> <span class="mi">9999</span>
  <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
  <span class="k">val</span> <span class="n">client</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">LengthBoundedClient</span><span class="o">(</span><span class="n">port</span><span class="o">)))</span>
  <span class="k">val</span> <span class="n">respondTo</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">RespondTo</span><span class="o">])</span>

  <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Console</span><span class="o">.</span><span class="n">readLine</span><span class="o">()</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="s">&quot;A&quot;</span> <span class="k">=&gt;</span> <span class="n">client</span> <span class="o">!</span> <span class="nc">Attach</span><span class="o">(</span><span class="n">respondTo</span><span class="o">)</span>
      <span class="k">case</span> <span class="s">&quot;D&quot;</span> <span class="k">=&gt;</span> <span class="n">client</span> <span class="o">!</span> <span class="nc">Detach</span>
      <span class="k">case</span> <span class="k">_@</span> <span class="n">s</span> <span class="k">=&gt;</span> <span class="n">client</span> <span class="o">!</span> <span class="n">s</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>


<strong>
 </strong>

<pre></pre>

</div>


          <div class="footer">
            <div class="contact">
              <p>
                Your Name<br />
                What You Are<br />
                you@example.com
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/yourusername">github.com/yourusername</a><br />
                <a href="https://twitter.com/yourusername">twitter.com/yourusername</a><br />
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
