<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Unusual java httpserver race condition</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Unusual java httpserver race condition</h2>
<p class="meta">29 Aug 2012</p>

<div class="post">
The<a href="http://docs.oracle.com/javase/7/docs/jre/api/net/httpserver/spec/com/sun/net/httpserver/package-summary.html"> JDK httpserver</a> provides a simple implementation that can easily be applied to unit tests.

The following example would generate a response containing <em>responseBytes.</em>
It might be expected that the referencing code would only see the response when <em>exchange.close()</em> is called.
In reality, the response can be seen as soon as the <em>write</em> executes!

That does not matter in a real web server since the client cannot be aware of the internal processing of the server.
Unit tests intrinsically couple the client and server together so as to progress through the test steps and validate the state of both parties.

This race condition caused unit tests to randomly fail, which is always hard to diagnose.

<div class="highlight"><pre><code class="scala"><span class="k">private</span> <span class="n">static</span> <span class="k">class</span> <span class="nc">MockHandler</span> <span class="n">implements</span> <span class="nc">HttpHandler</span><span class="o">{</span>
   <span class="nd">@Override</span>
   <span class="n">public</span> <span class="n">void</span> <span class="n">handle</span><span class="o">(</span><span class="nc">HttpExchange</span> <span class="n">exchange</span><span class="o">)</span> <span class="n">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
       <span class="n">exchange</span><span class="o">.</span><span class="n">getResponseBody</span><span class="o">().</span><span class="n">write</span><span class="o">(</span><span class="n">responseBytes</span><span class="o">);</span>
       <span class="n">exchange</span><span class="o">.</span><span class="n">close</span><span class="o">();</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

</div>


          <div class="footer">
            <div class="contact">
              <p>
                Your Name<br />
                What You Are<br />
                you@example.com
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/yourusername">github.com/yourusername</a><br />
                <a href="https://twitter.com/yourusername">twitter.com/yourusername</a><br />
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
