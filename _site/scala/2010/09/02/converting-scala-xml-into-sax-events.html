<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Converting Scala XML into SAX events</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">Your New Jekyll Site</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Converting Scala XML into SAX events</h2>
<p class="meta">02 Sep 2010</p>

<div class="post">
This object generates SAX events from Scala XML to the provided ContentHandler.
If the target also implements LexicalHandler then comments are included.

<div class="highlight"><pre><code class="scala"><span class="k">import</span> <span class="nn">scala.xml._</span>
<span class="k">import</span> <span class="nn">org.xml.sax.ext.LexicalHandler</span>
<span class="k">import</span> <span class="nn">org.xml.sax._</span>
<span class="k">import</span> <span class="nn">org.xml.sax.helpers._</span>

<span class="k">import</span> <span class="nn">scala.xml.Utility._</span>

<span class="k">object</span> <span class="nc">XMLDumper</span><span class="o">{</span>

   <span class="k">def</span> <span class="n">toXML</span><span class="o">(</span>
    <span class="n">x</span><span class="k">:</span> <span class="kt">Node</span><span class="o">,</span>
    <span class="n">target</span><span class="k">:</span> <span class="kt">ContentHandler</span><span class="o">,</span>
    <span class="n">pscope</span><span class="k">:</span> <span class="kt">NamespaceBinding</span> <span class="o">=</span> <span class="nc">TopScope</span><span class="o">)</span>
  <span class="o">{</span>
    <span class="k">val</span> <span class="n">lexical</span> <span class="k">=</span> <span class="k">if</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="n">isInstanceOf</span><span class="o">[</span><span class="kt">LexicalHandler</span><span class="o">])</span> <span class="n">target</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">LexicalHandler</span><span class="o">]</span> <span class="k">else</span> <span class="kc">null</span>

     <span class="n">target</span><span class="o">.</span><span class="n">startDocument</span>

    <span class="n">x</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="n">c</span><span class="k">:</span> <span class="kt">Comment</span> <span class="o">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">lexical</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">lexical</span><span class="o">.</span><span class="n">comment</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="n">commentText</span><span class="o">.</span><span class="n">toCharArray</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">c</span><span class="o">.</span><span class="n">commentText</span><span class="o">.</span><span class="n">length</span><span class="o">)</span>
      <span class="k">case</span> <span class="n">a</span><span class="k">:</span> <span class="kt">Atom</span><span class="o">[</span><span class="k">_</span><span class="o">]</span> <span class="k">=&gt;</span>  <span class="o">{</span> <span class="k">val</span> <span class="n">s</span> <span class="k">=</span> <span class="n">a</span> <span class="n">text</span><span class="o">;</span> <span class="n">target</span><span class="o">.</span><span class="n">characters</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">toCharArray</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">s</span><span class="o">.</span><span class="n">length</span><span class="o">)</span> <span class="o">}</span> 
      <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">EntityRef</span> <span class="o">=&gt;</span>  <span class="o">{</span> <span class="k">val</span> <span class="n">s</span> <span class="k">=</span> <span class="n">e</span> <span class="n">text</span><span class="o">;</span> <span class="n">target</span><span class="o">.</span><span class="n">characters</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">toCharArray</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">s</span><span class="o">.</span><span class="n">length</span><span class="o">)</span> <span class="o">}</span> 
      <span class="k">case</span>  <span class="n">p</span><span class="k">:</span><span class="kt">ProcInstr</span> <span class="o">=&gt;</span> <span class="n">target</span><span class="o">.</span><span class="n">processingInstruction</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="n">target</span><span class="o">,</span><span class="n">p</span><span class="o">.</span><span class="n">proctext</span><span class="o">)</span>
      <span class="k">case</span> <span class="n">g</span><span class="k">:</span> <span class="kt">Group</span> <span class="o">=&gt;</span>
        <span class="n">g</span><span class="o">.</span><span class="n">nodes</span> <span class="n">foreach</span> <span class="o">{</span><span class="n">toXML</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">x</span><span class="o">.</span><span class="n">scope</span><span class="o">)}</span>
      <span class="k">case</span> <span class="k">_</span>  <span class="k">=&gt;</span>
        <span class="k">val</span> <span class="n">uri</span> <span class="k">=</span> <span class="n">x</span><span class="o">.</span><span class="n">namespace</span>
        <span class="k">val</span> <span class="n">localName</span> <span class="k">=</span> <span class="n">x</span><span class="o">.</span><span class="n">label</span>
        <span class="k">val</span> <span class="n">qName</span> <span class="k">=</span> <span class="k">if</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="n">localName</span> <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">localName</span>

        <span class="k">val</span> <span class="n">atts</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">AttributesImpl</span><span class="o">()</span> 
        <span class="k">if</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">attributes</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">toXML</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">attributes</span><span class="o">,</span><span class="n">atts</span><span class="o">)</span>
        
        <span class="n">startPrefix</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">scope</span><span class="o">,</span><span class="n">pscope</span><span class="o">,</span><span class="n">target</span><span class="o">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">startElement</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span><span class="n">localName</span><span class="o">,</span><span class="n">qName</span><span class="o">,</span><span class="n">atts</span><span class="o">)</span>  
          <span class="n">x</span><span class="o">.</span><span class="n">child</span> <span class="n">foreach</span> <span class="o">{</span><span class="n">toXML</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">x</span><span class="o">.</span><span class="n">scope</span><span class="o">)}</span>
        <span class="n">target</span><span class="o">.</span><span class="n">endElement</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span><span class="n">localName</span><span class="o">,</span><span class="n">qName</span><span class="o">)</span> 
        <span class="n">endPrefix</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">scope</span><span class="o">,</span><span class="n">pscope</span><span class="o">,</span><span class="n">target</span><span class="o">)</span>  
    <span class="o">}</span>
    <span class="n">target</span><span class="o">.</span><span class="n">endDocument</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">startPrefix</span><span class="o">(</span><span class="n">ns</span><span class="k">:</span><span class="kt">NamespaceBinding</span><span class="o">,</span><span class="n">stop</span><span class="k">:</span><span class="kt">NamespaceBinding</span><span class="o">,</span><span class="n">target</span><span class="k">:</span><span class="kt">ContentHandler</span><span class="o">){</span>
     <span class="k">if</span><span class="o">(</span><span class="n">ns</span> <span class="n">ne</span> <span class="n">stop</span><span class="o">){</span>
        <span class="n">target</span><span class="o">.</span><span class="n">startPrefixMapping</span><span class="o">(</span><span class="k">if</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">prefix</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="s">&quot;&quot;</span> <span class="k">else</span> <span class="n">ns</span><span class="o">.</span><span class="n">prefix</span><span class="o">,</span><span class="n">ns</span><span class="o">.</span><span class="n">uri</span><span class="o">);</span>
         <span class="n">startPrefix</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">parent</span><span class="o">,</span> <span class="n">stop</span><span class="o">,</span><span class="n">target</span><span class="o">)</span>
     <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">endPrefix</span><span class="o">(</span><span class="n">ns</span><span class="k">:</span><span class="kt">NamespaceBinding</span><span class="o">,</span><span class="n">stop</span><span class="k">:</span><span class="kt">NamespaceBinding</span><span class="o">,</span><span class="n">target</span><span class="k">:</span><span class="kt">ContentHandler</span><span class="o">){</span>
     <span class="k">if</span><span class="o">(</span><span class="n">ns</span> <span class="n">ne</span> <span class="n">stop</span><span class="o">){</span>
       <span class="n">target</span><span class="o">.</span><span class="n">endPrefixMapping</span><span class="o">(</span><span class="k">if</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">prefix</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="s">&quot;&quot;</span> <span class="k">else</span> <span class="n">ns</span><span class="o">.</span><span class="n">prefix</span><span class="o">);</span>
       <span class="n">endPrefix</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">parent</span><span class="o">,</span> <span class="n">stop</span><span class="o">,</span><span class="n">target</span><span class="o">)</span>
     <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">toXML</span><span class="o">(</span><span class="n">att</span><span class="k">:</span><span class="kt">MetaData</span><span class="o">,</span><span class="n">atts</span><span class="k">:</span><span class="kt">AttributesImpl</span><span class="o">){</span>
     <span class="n">att</span> <span class="k">match</span>  <span class="o">{</span>
        <span class="k">case</span> <span class="n">pa</span><span class="k">:</span><span class="kt">PrefixedAttribute</span> <span class="o">=&gt;</span>  <span class="n">atts</span><span class="o">.</span><span class="n">addAttribute</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span><span class="n">pa</span><span class="o">.</span><span class="n">key</span><span class="o">,</span><span class="n">pa</span><span class="o">.</span><span class="n">pre</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">pa</span><span class="o">.</span><span class="n">key</span><span class="o">,</span><span class="s">&quot;CDATA&quot;</span><span class="o">,</span><span class="n">toString</span><span class="o">(</span><span class="n">pa</span><span class="o">.</span><span class="n">value</span><span class="o">))</span>
        <span class="k">case</span> <span class="n">ua</span><span class="k">:</span><span class="kt">UnprefixedAttribute</span> <span class="o">=&gt;</span>  <span class="n">atts</span><span class="o">.</span><span class="n">addAttribute</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span><span class="n">ua</span><span class="o">.</span><span class="n">key</span><span class="o">,</span><span class="n">ua</span><span class="o">.</span><span class="n">key</span><span class="o">,</span><span class="s">&quot;CDATA&quot;</span><span class="o">,</span><span class="n">toString</span><span class="o">(</span><span class="n">ua</span><span class="o">.</span><span class="n">value</span><span class="o">))</span>
        <span class="k">case</span> <span class="nc">Null</span> <span class="k">=&gt;</span>  <span class="c1">//ignored</span>
     <span class="o">}</span>
     <span class="k">if</span><span class="o">(</span><span class="n">att</span> <span class="n">hasNext</span><span class="o">)</span>
       <span class="n">toXML</span><span class="o">(</span><span class="n">att</span><span class="o">.</span><span class="n">next</span><span class="o">,</span><span class="n">atts</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">toString</span><span class="o">(</span><span class="n">ns</span><span class="k">:</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">Node</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
     <span class="k">val</span> <span class="n">sb</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span>
     <span class="n">ns</span> <span class="n">foreach</span> <span class="o">{</span><span class="k">_</span> <span class="k">match</span> <span class="o">{</span> 
          <span class="k">case</span> <span class="n">a</span><span class="k">:</span> <span class="kt">Atom</span><span class="o">[</span><span class="k">_</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="n">sb</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="o">)</span>
          <span class="k">case</span> <span class="n">e</span><span class="k">:</span><span class="kt">EntityRef</span> <span class="o">=&gt;</span> <span class="n">sb</span><span class="o">.</span><span class="n">append</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="n">text</span><span class="o">)</span>
        <span class="o">}</span>
      <span class="o">}</span>
     <span class="n">sb</span><span class="o">.</span><span class="n">toString</span>
  <span class="o">}</span>

<span class="o">}</span> 
</code></pre></div>

With example usage

<div class="highlight"><pre><code class="scala"><span class="k">import</span> <span class="nn">java.io._</span>
<span class="k">import</span> <span class="nn">javax.xml.parsers._</span>
<span class="k">import</span> <span class="nn">javax.xml.transform._</span>
<span class="k">import</span> <span class="nn">javax.xml.transform.sax._</span>
<span class="k">import</span> <span class="nn">javax.xml.transform.stream._</span>

<span class="k">object</span> <span class="nc">XMLDumperDriver</span> <span class="k">extends</span> <span class="nc">Application</span><span class="o">{</span>

<span class="k">val</span> <span class="n">transformerFactory</span> <span class="k">=</span> <span class="o">(</span><span class="nc">TransformerFactory</span><span class="o">.</span><span class="n">newInstance</span><span class="o">).</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">SAXTransformerFactory</span><span class="o">]</span>
<span class="k">val</span> <span class="n">xformer</span> <span class="k">=</span> <span class="n">transformerFactory</span><span class="o">.</span><span class="n">newTransformerHandler</span>
<span class="n">xformer</span><span class="o">.</span><span class="n">setResult</span><span class="o">(</span><span class="k">new</span> <span class="nc">StreamResult</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">out</span><span class="o">))</span>

  <span class="k">val</span> <span class="n">xml</span> <span class="k">=</span> <span class="o">&lt;</span><span class="nc">Outside</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">Y</span> <span class="n">xmlns</span><span class="o">=</span><span class="s">&quot;http://y&quot;</span><span class="o">/&gt;</span> <span class="o">&lt;</span><span class="n">X</span> <span class="n">a</span><span class="o">=</span><span class="s">&quot;12&quot;</span> <span class="n">c</span><span class="o">=</span><span class="s">&quot;21&quot;</span> <span class="n">xmlns</span><span class="k">:</span><span class="kt">h</span><span class="o">=</span><span class="s">&quot;http://com.com&quot;</span> <span class="n">xmlns</span><span class="k">:</span><span class="kt">q</span><span class="o">=</span><span class="s">&quot;http://q&quot;</span>  <span class="o">&gt;</span><span class="n">xxx</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;</span><span class="n">lt</span><span class="o">;</span> <span class="o">&lt;</span><span class="n">y</span> <span class="n">xmlns</span><span class="k">:</span><span class="kt">g</span><span class="o">=</span><span class="s">&quot;http://example.com&quot;</span>  <span class="n">h</span><span class="k">:</span><span class="kt">b</span><span class="o">=</span><span class="s">&quot;13&quot;</span><span class="o">/&gt;</span> <span class="o">&lt;/</span><span class="n">X</span><span class="o">&gt;</span> <span class="o">&lt;/</span><span class="nc">Outside</span><span class="o">&gt;</span>

 <span class="nc">XMLDumper</span><span class="o">.</span><span class="n">toXML</span><span class="o">(</span><span class="n">xml</span><span class="o">,</span><span class="n">xformer</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div>

</div>


          <div class="footer">
            <div class="contact">
              <p>
                Your Name<br />
                What You Are<br />
                you@example.com
              </p>
            </div>
            <div class="contact">
              <p>
                <a href="https://github.com/yourusername">github.com/yourusername</a><br />
                <a href="https://twitter.com/yourusername">twitter.com/yourusername</a><br />
              </p>
            </div>
          </div>
        </div>

    </body>
</html>
